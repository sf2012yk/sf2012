// Birmingham Manchester module

// é‰„é“ãƒ«ãƒ¼ãƒˆã€€ãƒãƒ¼ãƒŸãƒ³ã‚¬ãƒ â‡”ãƒžãƒ³ãƒã‚§ã‚¹ã‚¿ãƒ¼ãƒ»ã‚¨ãƒ‡ã‚£ãƒ³ãƒãƒ©ã€€//
const Birmingham_2 = [52.47781931496408, -1.89936569926818];
const UK_A38_BM = [52.47863238072362, -1.9050165995104456];
const Library_BM = [52.47903657605766, -1.9084296123985784];
const Arena_BM = [52.479690012751334, -1.9146952526474725];
const UK_A4540_BM = [52.481821089170836, -1.923813520301776];
const UK_A457_BM = [52.48678784315159, -1.9335309564033607];
const EMUDepot = [52.493428299589155, -1.9440989337408987];
const UK_A4135_BM = [52.49627644634553, -1.9560884127869567];
const SmethwickRolf = [52.496557974695705, -1.9704130009954601];
const SmethwickGalton = [52.502072554269944, -1.980400787109561];
const SandwellDudley = [52.508657232968815, -2.0117690272617015];
const DudleyPort = [52.52454430645847, -2.04948266930996];
const Tipton = [52.5304860618748, -2.065778299941713];
const Coseley = [52.54514597689015, -2.085785096378642];
const UK_A454_WV = [52.584653201493495, -2.1121461192912205];
const Wolverhampton = [52.58761744728619, -2.119535150690076];//Wolverhampton
const WV_Nouth = [52.58982889379586, -2.1220780754314643];
const UK_A460_WVJn = [52.59354476025125, -2.1242044990862317];
const BoneMillLn = [52.59556713043529, -2.1256073313311115];
const FoxsLn = [52.59796954022698, -2.126277340471105];
const ShowellRd = [52.60473363373608, -2.124838058031198];
const BushburyLn = [52.61008650637361, -2.124509780012258];
const ThreeTunsLn = [52.61947024994094, -2.1242042867069513];
const BeeLn = [52.625413693862114, -2.1219612188417956];
const UK_M54_WV = [52.638233326412745, -2.118135792234163];
const FourAshes = [52.672809746943564, -2.1245121742986175];
const GravellyWay = [52.68362346622236, -2.1274234330816015];
const WatlingSt_WV = [52.692599335884694, -2.1282580982082586];
const UK_A449_BH = [52.69816469471991, -2.1285554426862667];
const BunghamLn_BG = [52.718685140170884, -2.120463174892137];
const Penkridge = [52.72357932992172, -2.119425951735642]; //Penkridge
const PenkridgeBd = [52.732487761220405, -2.1180069984977496];
const School_Ln_SF = [52.75827725005886, -2.113640006071525];
const MossPit = [52.77482167662207, -2.110838765901378];
const RickerscottRd = [52.78408575355826, -2.1100040819581283];
const Stafford = [52.803656362052266, -2.1226777923744984];
const Doxey_Rd = [52.80809548289369, -2.129542182772828];
const UK_M6_Aston = [52.820726484994324, -2.152467757356826];
const UK_A5013 = [52.83990036293903, -2.1750118904001168];
const Worston_Ln = [52.85921261164306, -2.186602832155648];
const NortonBridgeJC = [52.868082740525814, -2.192824781722646];
const UK_B5026 = [52.87133627498176, -2.200126766281922];
const SwynnertonRd = [52.88607139951044, -2.2313029870354706];
const UK_A519_Cn = [52.895493186551725, -2.2494198327413195];
const MillLn = [52.91249977411266, -2.2588283059322327];
const UK_A51_Cn = [52.946038992732966, -2.2742813550404977];
const UK_A53_Cn = [52.96019433650469, -2.304827312380135];
const BarHill = [52.9947707298402, -2.341971318539012];
const AWC_CrewCn1 = [52.99908574901328, -2.3479458596906597];
const AWC_CrewCn2 = [53.011495603861476, -2.367305642943639];
const AWC_CrewCn3 = [53.01686481863134, -2.3739762567437905];
const AWC_CrewCn4 = [53.02678447160589, -2.385456286185543];
const AWC_CrewCn5 = [53.038181564224615, -2.3999780902827856];
const AWC_CrewCn6 = [53.04920163339655, -2.409688763995756];
const AWC_CrewCn7 = [53.058858283023, -2.415252595926119];
const CaseyLn = [53.06413252587175, -2.4182891714273853];
const UK_A500 = [53.07028304116613, -2.421831707606301];
const Crew = [53.08932585385701, -2.433754950451818];
const Crew_JC = [53.09215609606876, -2.434468055393238];
const UK_A532_CR = [53.09783374279306, -2.4312181265218062];
const SydneyRd = [53.10635158735606, -2.425185107692751];
const Sandbach = [53.15020256470174, -2.393739894788202];
const UK_M6_HC = [53.18168007906816, -2.368695563840705];
const HolmesChapel = [53.199054308296056, -2.351345803409646];
const TwemlowViaduct = [53.20778812149275, -2.342300806630357];
const Goostrey = [53.22252527310544, -2.3264034477540854];
const Chelford = [53.270346763093066, -2.280578297720916];
const UK_A34_AE = [53.285219701201974, -2.249618631938525];
const AlderleyEdge = [53.303741890843824, -2.236778894961991];
const UK_A34_WL = [53.31389738460313, -2.2312916552222832];
const UK_A538_WL = [53.32093401260888, -2.227596712941148];
const Wilmslow = [53.326731295593184, -2.2261040864057984];
const WilmslowNorthJn = [53.33007554102979, -2.2252832851891506];
const ManchesterAPJN_s = [53.357364555829484, -2.2410870453275535];
const ManchesterAPJN_c = [53.36017152742647, -2.240127655240635];
const ManchesterAPJN_n = [53.36463995634316, -2.238513072001016];
const HealdGreen = [53.36940585637484, -2.2366722186291135];
const Gatley = [53.39304408651991, -2.2309266011660847];
const EastDidsbury = [53.409250629600386, -2.222157181404132];
const MauldethRoad = [53.434026188897725, -2.2087289979689126];
const Fallowfield = [53.4420754071099, -2.2045259015024516];
const OldHallLn_s = [53.445461401792194, -2.20261560408342];
const OldHallLn_c = [53.44804583990507, -2.1999451797791743];
const SlaidLn = [53.44928225727697, -2.1975809945758074];
const Ardwick = [53.47095101742453, -2.213453637108757];
const CancellorLn = [53.47228541577204, -2.216212121971521];
const MancunianWay = [53.47434622267645, -2.2207205159697647];
const FairfieldRdMC = [53.47595810079016, -2.2249179884942443];
const Manchester = [53.477308627188506, -2.2299399620126628];

const AWC_BMMC = L.polyline([
Birmingham_2,UK_A38_BM,Library_BM,Arena_BM,UK_A4540_BM,UK_A457_BM,EMUDepot,UK_A4135_BM,SmethwickRolf,SmethwickGalton,
SandwellDudley,Tipton,Coseley,UK_A454_WV,
Wolverhampton,WV_Nouth,UK_A460_WVJn,BoneMillLn,FoxsLn,
ShowellRd,BushburyLn,ThreeTunsLn,BeeLn,UK_M54_WV,
FourAshes,GravellyWay,WatlingSt_WV,UK_A449_BH,BunghamLn_BG,
Penkridge,PenkridgeBd,School_Ln_SF,MossPit,RickerscottRd,
Stafford,Doxey_Rd,UK_M6_Aston,UK_A5013,Worston_Ln,NortonBridgeJC,UK_B5026,
SwynnertonRd,UK_A519_Cn,MillLn,UK_A51_Cn,UK_A53_Cn,
BarHill,AWC_CrewCn1,AWC_CrewCn2,AWC_CrewCn3,AWC_CrewCn4,AWC_CrewCn5,AWC_CrewCn6,AWC_CrewCn7,CaseyLn,UK_A500,
Crew,Crew_JC,UK_A532_CR,SydneyRd,Sandbach,UK_M6_HC,HolmesChapel,TwemlowViaduct,Goostrey,Chelford,UK_A34_AE,
AlderleyEdge,UK_A34_WL,UK_A538_WL,
Wilmslow,WilmslowNorthJn,ManchesterAPJN_s,ManchesterAPJN_c,ManchesterAPJN_n,
HealdGreen,Gatley,EastDidsbury,MauldethRoad,Fallowfield,OldHallLn_s,OldHallLn_c,SlaidLn,
Ardwick,CancellorLn,MancunianWay,FairfieldRdMC,Manchester], { color: '#000000' }).addTo(map);


// Birmingham â†’ Manchester
//ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ã‚’ç„¡åˆ¶é™åˆ¶é™
map.on('popupopen', function (e) {
  const ManchesterBtn = document.getElementById('BirminghamtoManchesterCard');
  if (ManchesterBtn) {
    const newBtn = ManchesterBtn.cloneNode(true);
    ManchesterBtn.parentNode.replaceChild(newBtn, ManchesterBtn);

    newBtn.addEventListener('click', () => {
      if (!animationRunning) {
        goToBirminghamtoManchester();
      }
    });
  }
  })

function goToBirminghamtoManchester() {
  if (animationRunning) return; // â† ã™ã§ã«å‹•ã„ã¦ã„ãŸã‚‰ä½•ã‚‚ã—ãªã„
  animationRunning = true;

  markerBirmingham.closePopup(); // â† ç§»å‹•å‰ã«ï¼ˆå§‹ç™ºï¼‰ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹

  // ðŸš„ ã‚¢ã‚¤ã‚³ãƒ³ä»˜ããƒžãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºï¼ˆåˆæœŸä½ç½®ï¼‰
  const trainIcon = L.icon({
    iconUrl: "image/icon/train_test.png",// ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®URL
    iconRetinaUrl:"image/icon/train_test@2x.png",
    iconSize: [40, 40],
    iconAnchor: [25, 25],
    className: "icon-train"
  });

  const trainMarker = L.marker(Birmingham_2, { icon: trainIcon }).addTo(map);

  const fullPath = interpolatePolyline(AWC_BMMC , 50);// â† æ•°å­—ãŒå°‘ãªã„ã»ã©ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—

  const BirminghamtoManchesterIndex = fullPath.findIndex(p => 
    Math.abs(p[0] - Manchester[0]) < 0.0001 && 
    Math.abs(p[1] - Manchester[1]) < 0.0001
  );

  const pathToBirminghamtoManchester = fullPath.slice(0, BirminghamtoManchesterIndex + 1);
  
  const totalFrames = pathToBirminghamtoManchester.length;

  let frame = 0;

  function animate() {
   
   const index = frame;

    if (index < pathToBirminghamtoManchester.length) {
      trainMarker.setLatLng(pathToBirminghamtoManchester[index]); // â† ãƒžãƒ¼ã‚«ãƒ¼ã‚’ç§»å‹•
      map.panTo(pathToBirminghamtoManchester[index], { animate: true, duration: 0.25 });
      frame++;
      setTimeout(animate, 5); // â† é€Ÿåº¦èª¿æ•´ï¼ˆæ•°å­—ãŒå°‘ãªã„ã»ã©ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼‰
    } else {
      setTimeout(() => {
        markerManchester.openPopup();
        map.removeLayer(trainMarker); // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤
        animationRunning = false;
      }, 100);

    }
  }
  animate();
}