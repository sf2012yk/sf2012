// London Manchester module

// é‰„é“ãƒ«ãƒ¼ãƒˆã€€ãƒ­ãƒ³ãƒ‰ãƒ³â‡”ãƒãƒ¼ãƒŸãƒ³ã‚¬ãƒ ã€€//
const Euston = [51.52948, -0.13537];
const MorningtonCrescent = [51.53395062345362, -0.14292321153300808];
const ChalkFarm = [51.54314862375889, -0.1564557870053156];
const SouthHampstead = [51.54135664654098, -0.17931861465824592];
const KilburnHighRoad = [51.53727271274826, -0.19245070998309324];
const QueensPark = [51.53403914827336, -0.20443189353795324];
const KensalGreen = [51.530395337010766, -0.2254278543566688];
const Willesden = [51.53146322882626, -0.24362396039768464];
const Harlesden = [51.53572993348321, -0.25734208449787865];
const Wembley = [51.55230618916263, -0.2965995729806941];
const SouthKenton = [51.569925507225555, -0.3080654374639343];
const Kenton = [51.581640918460856, -0.31656236708817426];
const HarrowWealdstone = [51.59183431471163, -0.3342093312837065];
const HatchEnd = [51.60945715754306, -0.3681855429959627];
const CarpendersPark = [51.62757910884814, -0.3852694311494912];
const Bushey = [51.64525218841952, -0.38496223134459345];
const UK_A4008 = [51.656715419139964, -0.38695247918173925];
const Watford = [51.6635182082345, -0.39620408280704633];
const UK_A4_WT = [51.684393478279404, -0.42353641577430223];
const KingsLangley_M25 = [51.7051053453944, -0.43767217718493995];
const NashMills = [51.723046141993215, -0.44763333223239365];
const Apsley = [51.73245713831994, -0.4631369309219028];
const UK_A414 = [51.738436273229105, -0.4762639415327257];
const HemelHempstead = [51.74227419662148, -0.4908939297602195];
const BourneEnd = [51.754443789543814, -0.5409820375475456];
const Berkhamsted = [51.76328455798022, -0.5618396247312955];
const UK_B4506 = [51.772178885366756, -0.5865098597105388];
const Tring = [51.80091473328521, -0.6226420132845407];
const CollegeLake = [51.816489983852804, -0.6406278809481464];
const UK_B489 = [51.82846061574841, -0.6511270777332941];
const Cheddington = [51.858127121370586, -0.6618948955424322];
const UK_A4145 = [51.90088461212778, -0.6772933022537566];
const LeightonBuzzard = [51.91633151604649, -0.6772633498536336];
const LinsladeTunnels = [51.92515317734566, -0.6761352676323952];
const UK_A4145_2 = [51.943538334159584, -0.7079888237507251];
const StokeHammond_1 = [51.950151188075594, -0.718040751446702];
const StokeHammond_2  = [51.95771546050419, -0.7241776457417981];
const UK_A4146 = [51.97231530867344, -0.7291390375267331];
const Bletchley = [51.99536301938513, -0.7363917307305143];
const WatlingSt = [52.009551198147285, -0.7436809479822809];
const UK_A5_Standing = [52.014120651970664, -0.7485011995468883];
const Miltonkeynes = [52.033917623892144, -0.7743683008947302];
const UK_H5 = [52.05040725100327, -0.7959880935238673];
const UK_H2 = [52.05564566176277, -0.8008760442621004];
const Wolverton = [52.065287635090854, -0.8043283314470698];
const WolvertonViaduct = [52.07223478307274, -0.8116734670598433];
const Castlethorpe = [52.09297704811086, -0.8390460330851991];
const HanslopeJC = [52.11827103995909, -0.8602540343285142];
const Ashton = [52.14163354427546, -0.8785234802114368];
const Roade = [52.15726182254678, -0.8980010157011035];
const CourteenhallJC = [52.17012678996676, -0.9088909079164516];
const UK_A43 = [52.18597093976964, -0.9496129828753063];
const UK_A5_ChurchStowe = [52.22053394965017, -1.0596929162221713];
const WeedonBec = [52.22787925918242, -1.075030586515375];
const RoadWeedon = [52.233964193286766, -1.0805022929221675];
const UK_A45_RM = [52.23701312322497, -1.0848287544718138];
const UK_A5_RM = [52.24896946109069, -1.0856012306487954];
const Muscott = [52.26311234632907, -1.0917699348262426];
const Norton = [52.27468902560455, -1.097506154781783];
const ThreeBridgesRd = [52.284108373884216, -1.1015804444435273];
const UK_B5385 = [52.307483481878975, -1.1262480513775708];
const KilsbyTNSouth = [52.32268151586431, -1.1525408772768704];
const UK_A45_KB = [52.3270027714065, -1.158227160383134];
const KilsbyTNCt = [52.33277253029558, -1.1654369382962537];
const KilsbyTNNo = [52.33969524779288, -1.1743633297568759];
const CrickRd = [52.35671253436747, -1.198906274846273];
const RugbyJC = [52.37462036919268, -1.2356874334370054];
const Rugby = [52.379088845181684, -1.251328473114462];
const UK_A426_1 = [52.38080386336462, -1.264806282401874];
const UK_A4071 = [52.3794582498776, -1.2797279209045236];
const UK_A428_1 = [52.37945144846293, -1.336226585064215];
const UK_B4455 = [52.380514274851876, -1.374511820569574];
const BrandonLn = [52.382610702571796, -1.4283537101722745];
const UK_A46_CV = [52.386251644658245, -1.4449404907334025];
const UK_A4082 = [52.393668088229546, -1.471933930217923];
const UK_A4214 = [52.39787670117208, -1.4963619577138443];
const Coventry = [52.40092122385774, -1.5139694373703751];
const Canley = [52.399370958063834, -1.5477059787810763];
const UK_A45_CaL = [52.39790566817065, -1.557104091546835];
const TileHill = [52.39520659102314, -1.5970687046683185];
const Berkswell = [52.39592092522684, -1.6412940907908051];
const UK_A452_HA = [52.403232728654906, -1.6586577320715838];
const HamptoninArden = [52.42866378509079, -1.6997435538805594];
const UK_M42_Hampton = [52.440286920745095, -1.7129735631876972];
const BirminghamInAirport = [52.450706951892045, -1.7252100863914703];
const MarstonGreen = [52.466923419863946, -1.7552674102141093];
const LeaHall = [52.480454056606604, -1.7859212767620185];
const Stechford = [52.48501350497633, -1.809863526828113];
const AdderleyPark = [52.48302710697651, -1.8561045657550468];
const UK_A4540 = [52.48149320370162, -1.8778521935916594];
const MoorStreet = [52.47895791903126, -1.8920571725379094];
const Birmingham = [52.47781931496408, -1.89936569926818];

const AWC_ESBM = L.polyline([
Euston,MorningtonCrescent,ChalkFarm,SouthHampstead,KilburnHighRoad,QueensPark,
KensalGreen,Willesden,Harlesden,Wembley,SouthKenton,Kenton,HarrowWealdstone,HatchEnd,CarpendersPark,Bushey,
Watford, UK_A4_WT,KingsLangley_M25,NashMills,Apsley,UK_A414,HemelHempstead,BourneEnd,Berkhamsted,UK_B4506,
Tring,CollegeLake,UK_B489,Cheddington,UK_A4145,LeightonBuzzard,LinsladeTunnels,UK_A4145_2,StokeHammond_1,StokeHammond_2,UK_A4146,
Bletchley,WatlingSt,UK_A5_Standing,Miltonkeynes, UK_H5,UK_H2,
Wolverton,WolvertonViaduct,Castlethorpe,Ashton,Roade,CourteenhallJC,UK_A43,UK_A5_ChurchStowe,
WeedonBec,RoadWeedon,UK_A45_RM,UK_A5_RM,Muscott,Norton,ThreeBridgesRd,UK_B5385,
KilsbyTNSouth,UK_A45_KB,KilsbyTNCt,KilsbyTNNo,CrickRd,RugbyJC,
Rugby, UK_A426_1,UK_A4071,UK_A428_1,UK_B4455,BrandonLn,UK_A46_CV,UK_A4082,UK_A4214,
Coventry,Canley,UK_A45_CaL,TileHill,Berkswell,UK_A452_HA,HamptoninArden,UK_M42_Hampton,
BirminghamInAirport,MarstonGreen,LeaHall,Stechford,AdderleyPark,UK_A4540,MoorStreet,Birmingham
], { color: '#000000' }).addTo(map);


// Euston â†’ Birminghamã¸æ»‘ã‚‰ã‹ã«ç§»å‹•ã™ã‚‹é–¢æ•°
//ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ã‚’ç„¡åˆ¶é™åˆ¶é™
map.on('popupopen', function (e) {
  const BirminghamBtn = document.getElementById('goToBirminghamCard');
  if (BirminghamBtn) {
    const newBtn = BirminghamBtn.cloneNode(true);
    BirminghamBtn.parentNode.replaceChild(newBtn, BirminghamBtn);

    newBtn.addEventListener('click', () => {
      if (!animationRunning) {
        goToBirmingham();
      }
    });
  }
  })

function goToBirmingham() {
  if (animationRunning) return; // â† ã™ã§ã«å‹•ã„ã¦ã„ãŸã‚‰ä½•ã‚‚ã—ãªã„
  animationRunning = true;

  markerEuston.closePopup(); // â† ç§»å‹•å‰ã«Eustonï¼ˆå§‹ç™ºï¼‰ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹

  // ðŸš„ ã‚¢ã‚¤ã‚³ãƒ³ä»˜ããƒžãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºï¼ˆåˆæœŸä½ç½®ï¼‰
  const trainIcon = L.icon({
    iconUrl: "image/icon/train_test.png",// ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®URL
    iconRetinaUrl:"image/icon/train_test@2x.png",
    iconSize: [40, 40],
    iconAnchor: [25, 25],
    className: "icon-train"
  });

  const trainMarker = L.marker(Euston, { icon: trainIcon }).addTo(map);

  const fullPath = interpolatePolyline(AWC_ESBM , 50);// â† æ•°å­—ãŒå°‘ãªã„ã»ã©ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—

  const BirminghamIndex = fullPath.findIndex(p => 
    Math.abs(p[0] - Birmingham[0]) < 0.0001 && 
    Math.abs(p[1] - Birmingham[1]) < 0.0001
  );

  const pathToBirmingham = fullPath.slice(0, BirminghamIndex + 1);
  const totalFrames = pathToBirmingham.length;
  let frame = 0;

  function animate() {
   
   const index = frame;

    if (index < pathToBirmingham.length) {
      trainMarker.setLatLng(pathToBirmingham[index]); // â† ãƒžãƒ¼ã‚«ãƒ¼ã‚’ç§»å‹•
      map.panTo(pathToBirmingham[index], { animate: true, duration: 0.25 });
      frame++;
      setTimeout(animate, 5); // â† é€Ÿåº¦èª¿æ•´ï¼ˆæ•°å­—ãŒå°‘ãªã„ã»ã©ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼‰
    } else {
      setTimeout(() => {
        markerBirmingham.openPopup();
        map.removeLayer(trainMarker); // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤
        animationRunning = false;
      }, 100);

    }
  }
  animate();
}

// Birminghamã€€â†’ã€€Eustonã¸æ»‘ã‚‰ã‹ã«æˆ»ã‚‹é–¢æ•°
//ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ã‚’ç„¡åˆ¶é™åˆ¶é™
map.on('popupopen', function (e) {
  const EustonBtn = document.getElementById('BirminghamtoEustonCard');
  if (EustonBtn) {
    const newBtn = EustonBtn.cloneNode(true);
    EustonBtn.parentNode.replaceChild(newBtn, EustonBtn);

    newBtn.addEventListener('click', () => {
      if (!animationRunning) {
        goToEuston();
      }
    });
  }
  })

function goToEuston() {
  if (animationRunning) return; // â† ã™ã§ã«å‹•ã„ã¦ã„ãŸã‚‰ä½•ã‚‚ã—ãªã„
  animationRunning = true;

  markerBirmingham.closePopup(); // â† ç§»å‹•å‰ã«Birminghamã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹

  // ðŸš„ ã‚¢ã‚¤ã‚³ãƒ³ä»˜ããƒžãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºï¼ˆåˆæœŸä½ç½®ï¼‰
  const trainIcon = L.icon({
    iconUrl: "image/icon/train_test.png",// ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®URL
    iconRetinaUrl:"image/icon/train_test@2x.png",
    iconSize: [40, 40],
    iconAnchor: [25, 25],
    className: "icon-train"
  });

  const trainMarker = L.marker(Birmingham, { icon: trainIcon }).addTo(map);

  const fullPath = [...interpolatePolyline(AWC_ESBM, 50)].reverse();// â† æ•°å­—ãŒå°‘ãªã„ã»ã©ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—

  const EustonIndex = fullPath.findIndex(p => 
    Math.abs(p[0] - Euston[0]) < 0.0001 && 
    Math.abs(p[1] - Euston[1]) < 0.0001
  );

  const pathToEuston = fullPath.slice(0, EustonIndex + 1);
  
// æœ€åˆã«ã‚¸ãƒ£ãƒ³ãƒ—ã‚’é˜²ã
  map.panTo(pathToEuston[0], { animate: false });


  let frame = 0;

  function animate() {
   
   const index = frame;

    if (index < pathToEuston.length) {
      trainMarker.setLatLng(pathToEuston[index]); // â† ãƒžãƒ¼ã‚«ãƒ¼ã‚’ç§»å‹•
      map.panTo(pathToEuston[index], { animate: true, duration: 0.25 });
      frame++;
      setTimeout(animate, 5); // â† é€Ÿåº¦èª¿æ•´ï¼ˆæ•°å­—ãŒå°‘ãªã„ã»ã©ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼‰
    } else {
      setTimeout(() => {
        markerEuston.openPopup();
        map.removeLayer(trainMarker); // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤
        animationRunning = false;
      }, 100);

    }
  }
  animate();
}